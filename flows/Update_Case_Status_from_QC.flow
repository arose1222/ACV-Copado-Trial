<?xml version="1.0" encoding="UTF-8"?>
<Flow xmlns="http://soap.sforce.com/2006/04/metadata">
    <apiVersion>53.0</apiVersion>
    <assignments>
        <name>Count_of_QC_Records</name>
        <label>Count of QC Records</label>
        <locationX>364</locationX>
        <locationY>741</locationY>
        <assignmentItems>
            <assignToReference>NumberofQCRecords</assignToReference>
            <operator>AssignCount</operator>
            <value>
                <elementReference>Get_All_QC_Records</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Look_at_all_QC_Records</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>Number_of_Closed_QC_Records</name>
        <label>Number of Closed QC Records</label>
        <locationX>796</locationX>
        <locationY>631</locationY>
        <assignmentItems>
            <assignToReference>NumberofClosedQCRecords</assignToReference>
            <operator>Add</operator>
            <value>
                <numberValue>1.0</numberValue>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Look_at_all_QC_Records</targetReference>
        </connector>
    </assignments>
    <decisions>
        <name>Are_all_QC_Records_Closed</name>
        <label>Are all QC Records Closed</label>
        <locationX>891</locationX>
        <locationY>309</locationY>
        <defaultConnectorLabel>QC Not Closed</defaultConnectorLabel>
        <rules>
            <name>QC_Closed</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>Look_at_all_QC_Records.Status__c</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <stringValue>Closed</stringValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Number_of_Closed_QC_Records</targetReference>
            </connector>
            <label>QC Closed</label>
        </rules>
        <rules>
            <name>All_QC_Records_Are_Closed_No_Hold</name>
            <conditionLogic>1 AND (2 OR 3)</conditionLogic>
            <conditions>
                <leftValueReference>NumberofQCRecords</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <elementReference>NumberofClosedQCRecords</elementReference>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>Get_Case_Record.Account.Title_Hold__c</leftValueReference>
                <operator>NotEqualTo</operator>
                <rightValue>
                    <stringValue>Do Not Send Titles</stringValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>Get_Case_Record.Account.Title_Hold__c</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>true</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Disable_Validation_Rule_0</targetReference>
            </connector>
            <label>All QC Records Are Closed No Hold</label>
        </rules>
        <rules>
            <name>All_QC_Records_Closed_Title_Hold</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>NumberofClosedQCRecords</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <elementReference>NumberofQCRecords</elementReference>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>Get_Case_Record.Account.Title_Hold__c</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <stringValue>Do Not Send Titles</stringValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Disable_Validation_Rule</targetReference>
            </connector>
            <label>All QC Records Closed Title Hold</label>
        </rules>
    </decisions>
    <decisions>
        <name>Is_case_in_Problem_or_Return_To_Seller_Status</name>
        <label>Is case in Problem or Return To Seller Status?</label>
        <locationX>167</locationX>
        <locationY>566</locationY>
        <defaultConnectorLabel>Not problem related Status</defaultConnectorLabel>
        <rules>
            <name>Case_is_Problem_or_Return_to_Seller</name>
            <conditionLogic>or</conditionLogic>
            <conditions>
                <leftValueReference>Get_Case_Record.Status</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <stringValue>Problem</stringValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>Get_Case_Record.Status</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <stringValue>Return to Seller</stringValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Get_All_QC_Records</targetReference>
            </connector>
            <label>Case is Problem or Return to Seller</label>
        </rules>
    </decisions>
    <description>Looks at the QC records to see when all are closed and then updates the related case to Working  or or Received. The goal of this flow is to reduce the updates needed to be made when closing out the QC record.</description>
    <interviewLabel>Update Case Status from QC {!$Flow.CurrentDateTime}</interviewLabel>
    <label>Update Case Status from QC</label>
    <loops>
        <name>Look_at_all_QC_Records</name>
        <label>Look at all QC Records</label>
        <locationX>365</locationX>
        <locationY>391</locationY>
        <collectionReference>Get_All_QC_Records</collectionReference>
        <iterationOrder>Asc</iterationOrder>
        <nextValueConnector>
            <targetReference>Are_all_QC_Records_Closed</targetReference>
        </nextValueConnector>
        <noMoreValuesConnector>
            <targetReference>Are_all_QC_Records_Closed</targetReference>
        </noMoreValuesConnector>
    </loops>
    <processMetadataValues>
        <name>BuilderType</name>
        <value>
            <stringValue>LightningFlowBuilder</stringValue>
        </value>
    </processMetadataValues>
    <processMetadataValues>
        <name>CanvasMode</name>
        <value>
            <stringValue>FREE_FORM_CANVAS</stringValue>
        </value>
    </processMetadataValues>
    <processMetadataValues>
        <name>OriginBuilderType</name>
        <value>
            <stringValue>LightningFlowBuilder</stringValue>
        </value>
    </processMetadataValues>
    <processType>AutoLaunchedFlow</processType>
    <recordLookups>
        <name>Get_All_QC_Records</name>
        <label>Get All QC Records</label>
        <locationX>172</locationX>
        <locationY>741</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>Count_of_QC_Records</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>Case__c</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>Get_Case_Record.Id</elementReference>
            </value>
        </filters>
        <getFirstRecordOnly>false</getFirstRecordOnly>
        <object>Quality_Control__c</object>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordLookups>
    <recordLookups>
        <name>Get_Case_Record</name>
        <label>Get Case Record</label>
        <locationX>175</locationX>
        <locationY>415</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>Is_case_in_Problem_or_Return_To_Seller_Status</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>Id</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>$Record.Case__r.Id</elementReference>
            </value>
        </filters>
        <getFirstRecordOnly>true</getFirstRecordOnly>
        <object>Case</object>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordLookups>
    <recordUpdates>
        <description>looks to the custom metadata called TitleProblemStatus and allows us to utilize the disable validation field to bypass the validation rule saying all QC records have to be closed to update the status from Problem or Return to seller - we then turn back on after the update is made.  Since this flow already checks all are closed we do not need to pass through that validation here.</description>
        <name>Disable_Validation_Rule</name>
        <label>Disable Validation Rule</label>
        <locationX>1038</locationX>
        <locationY>167</locationY>
        <connector>
            <targetReference>Update_Case_to_Received</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>EasyName__c</field>
            <operator>Contains</operator>
            <value>
                <stringValue>ACVOrg</stringValue>
            </value>
        </filters>
        <inputAssignments>
            <field>DisableValidation__c</field>
            <value>
                <booleanValue>true</booleanValue>
            </value>
        </inputAssignments>
        <object>TitleProblemStatus__c</object>
    </recordUpdates>
    <recordUpdates>
        <description>looks to the custom metadata called TitleProblemStatus and allows us to utilize the disable validation field to bypass the validation rule saying all QC records have to be closed to update he status from Problem or Return to seller - we then turn back on after the update is made.  Since this flow already checks all are closed we do not need to pass through that validation here.</description>
        <name>Disable_Validation_Rule_0</name>
        <label>Disable Validation Rule</label>
        <locationX>1042</locationX>
        <locationY>477</locationY>
        <connector>
            <targetReference>Update_Case_to_Working</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>EasyName__c</field>
            <operator>Contains</operator>
            <value>
                <stringValue>ACVOrg</stringValue>
            </value>
        </filters>
        <inputAssignments>
            <field>DisableValidation__c</field>
            <value>
                <booleanValue>true</booleanValue>
            </value>
        </inputAssignments>
        <object>TitleProblemStatus__c</object>
    </recordUpdates>
    <recordUpdates>
        <description>Looks to the custom metadata called TitleProblemStatus and turns disable Validation Back to false</description>
        <name>Disable_Validation_Rule_0_0</name>
        <label>Turn Disable Validation Off</label>
        <locationX>1304</locationX>
        <locationY>481</locationY>
        <filterLogic>and</filterLogic>
        <filters>
            <field>EasyName__c</field>
            <operator>Contains</operator>
            <value>
                <stringValue>ACVOrg</stringValue>
            </value>
        </filters>
        <inputAssignments>
            <field>DisableValidation__c</field>
            <value>
                <booleanValue>false</booleanValue>
            </value>
        </inputAssignments>
        <object>TitleProblemStatus__c</object>
    </recordUpdates>
    <recordUpdates>
        <description>Looks to the custom metadata called TitleProblemStatus and turns disable Validation Back to false</description>
        <name>Turn_Disable_Validation_Off</name>
        <label>Turn Disable Validation Off</label>
        <locationX>1304</locationX>
        <locationY>167</locationY>
        <filterLogic>and</filterLogic>
        <filters>
            <field>EasyName__c</field>
            <operator>Contains</operator>
            <value>
                <stringValue>ACVOrg</stringValue>
            </value>
        </filters>
        <inputAssignments>
            <field>DisableValidation__c</field>
            <value>
                <booleanValue>false</booleanValue>
            </value>
        </inputAssignments>
        <object>TitleProblemStatus__c</object>
    </recordUpdates>
    <recordUpdates>
        <description>This is used to bypass the validation rule that will not allow title cases where the Buyer is on a title hold to be moved to working - but we still want this out of problem so we are pushing it back to received and then it can we worked and still hit the appropriate error.</description>
        <name>Update_Case_to_Received</name>
        <label>Update Case to Received</label>
        <locationX>1173</locationX>
        <locationY>166</locationY>
        <connector>
            <targetReference>Turn_Disable_Validation_Off</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>Id</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>$Record.Case__r.Id</elementReference>
            </value>
        </filters>
        <inputAssignments>
            <field>Marked_Working__c</field>
            <value>
                <elementReference>varClosingUser</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>Update_Status__c</field>
            <value>
                <stringValue>Received</stringValue>
            </value>
        </inputAssignments>
        <object>Case</object>
    </recordUpdates>
    <recordUpdates>
        <name>Update_Case_to_Working</name>
        <label>Update Case to Working</label>
        <locationX>1171</locationX>
        <locationY>478</locationY>
        <connector>
            <targetReference>Disable_Validation_Rule_0_0</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>Id</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>$Record.Case__r.Id</elementReference>
            </value>
        </filters>
        <inputAssignments>
            <field>Marked_Working__c</field>
            <value>
                <elementReference>varClosingUser</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>Update_Status__c</field>
            <value>
                <stringValue>Working</stringValue>
            </value>
        </inputAssignments>
        <object>Case</object>
    </recordUpdates>
    <start>
        <locationX>52</locationX>
        <locationY>53</locationY>
        <connector>
            <targetReference>Get_Case_Record</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>Status__c</field>
            <operator>IsChanged</operator>
            <value>
                <booleanValue>true</booleanValue>
            </value>
        </filters>
        <object>Quality_Control__c</object>
        <recordTriggerType>Update</recordTriggerType>
        <triggerType>RecordAfterSave</triggerType>
    </start>
    <status>Active</status>
    <variables>
        <name>EachQCRecord</name>
        <dataType>SObject</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <objectType>Quality_Control__c</objectType>
    </variables>
    <variables>
        <name>FieldHistoryID</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>false</isOutput>
    </variables>
    <variables>
        <name>NumberofClosedQCRecords</name>
        <dataType>Number</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>false</isOutput>
        <scale>2</scale>
    </variables>
    <variables>
        <name>NumberofQCRecords</name>
        <dataType>Number</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>false</isOutput>
        <scale>2</scale>
    </variables>
    <variables>
        <name>varClosingUser</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
    </variables>
</Flow>
